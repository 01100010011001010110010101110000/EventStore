<!doctype html>
<html>
<head>
    <title>Users</title>
    <script src="/web/es/lib/jquery/jquery-1.8.0.min.js" type="text/javascript"></script>
    <script src="/web/es/lib/jquery/jquery-ui-1.8.23.min.js" type="text/javascript"></script>
    <script src="/web/es/lib/jsrender/jsrender.js" type="text/javascript"></script>
    <script src="/web/es/lib/require-full.js" type="text/javascript"></script>
    <script src="/web/es/js/es.tmpl.js" type="text/javascript"></script>
    <script id="r-head">
        es.tmpl.renderHead();
    </script>
    <style type="text/css">
        .dialog
        {
            display: none;
        }
    </style>
</head>
<body>
    <div id="content">
        <h1>Users</h1>
        <div id="commands-container">
            <ul style="display: inline;">
                <li><a href="#" id="btn-create" class="btn btn-info">New...</a></li>
                <li></li>
            </ul>
        </div>
        <div id="user-list-container"></div>
        <script id="r-body">
            es.tmpl.renderBody();
        </script>
    </div>
    <div id="user-details-dialog" class="dialog form-horizontal">
        <div id="user-details-dialog-content"></div>
        <div class="commands-container" style="text-align: right;">
            <ul style="display: inline">
                <li><a href="#" class="btn btn-info" id="button-details-edit">Edit...</a></li>
                <li><a href="#" class="btn btn-danger" id="button-details-delete">Delete...</a></li>
                <li><a href="#" class="btn btn-info" id="button-details-reset-password">Reset Password...</a></li>
                <li><a href="#" class="btn" id="button-details-cancel">Cancel</a></li>
            </ul>
        </div>
    </div>
    <div id="edit-user-details-dialog" class="dialog">
        <form id="edit-user-details-form" class="form-horizontal">
            <div class="control-group">
                <label class="control-label add-on" for="input-login-name">Login</label>
                <div class="controls">
                    <input type="text" id="input-login-name" name="input-login-name" data-required/>
                    <span class="help-inline"></span>
                </div>
            </div>
            <div class="control-group">
                <label class="control-label add-on" for="input-full-name">Full Name</label>
                <div class="controls">
                    <input type="text" id="input-full-name" name="input-full-name" data-required/>
                    <span class="help-inline"></span>
                </div>
            </div>
            <div class="control-group create-only">
                <label class="control-label add-on" for="input-password">Password</label>
                <div class="controls">
                    <input type="password" id="input-password" name="input-password" data-required/>
                    <span class="help-inline"></span>
                </div>
            </div>
            <div class="control-group create-only">
                <label class="control-label add-on" for="input-password">Confirm</label>
                <div class="controls">
                    <input type="password" id="input-password-confirm" name="input-password-confirm" data-confirm="input-password" />
                    <span class="help-inline"></span>
                </div>
            </div>
            <div class="commands-container" style="text-align: right;">
                <ul style="display: inline">
                    <li><a href="#" class="btn btn-primary" id="button-ok">Create</a></li>
                    <li><a href="#" class="btn" id="button-cancel">Cancel</a></li>
                </ul>
            </div>
        </form>
    </div>
    <script id="users-template" type="text/x-jsrender">
             <table class="table table-bordered table-striped queue-stats" style="table-layout: fixed; ">
                <thead>
                    <tr>
                        <th style="width: 70px;">Login Name</th>
                        <th style="width: 120px;">Full Name</th>
                        <th style="width: 50px;">Disabled</th>
                        <th style="width: 50px;">Updated</th>
                    </tr>
                </thead>
                <tbody class="stats-body">
                    {{for data}}
                    <tr>
                      <td><a href="#" class="user-login" data-login="{{>loginName}}">{{>loginName}}<a/></td>
                      <td>{{>fullName}}</td>
                      <td>{{>disabled}}</td>
                      <td>{{>dateLastUpdated}}</td>
                    </tr>
                    {{/for}}
                </tbody>
            </table>
        
    </script>
    <script id="user-template" type="text/x-jsrender">
            <div class="control-group">
                <div class="control-label"><label>Login:</label></div>
                <div class="controls">{{>loginName}}</div>
            </div>
            <div class="control-group">
                <div class="control-label"><label>Full Name:</label></div>
                <div class="controls">{{>fullName}}</div>
            </div>
            <div class="control-group">
                <div class="control-label"><label>Disabled:</label></div>
                <div class="controls">{{>disabled}}</div>
            </div>
            <div class="control-group">
                <div class="control-label"><label>Last Updated:</label></div>
                <div class="controls">{{>dateLastUpdated}}</div>
            </div>
    
    </script>
    <script type="text/javascript">
        require.config({ baseUrl: "/web/users/js" });
        require(['Controller'],
            function (controller) {
                var users = controller.create();
                $(function () {

                    $.templates({
                        usersTemplate: "#users-template",
                        userTemplate: "#user-template",
                });


                    $("#btn-create").click(function(e) {
                        e.preventDefault();
                        displayCreateUser();
                    });

                    $("form").submit(function(e) {
                        e.preventDefault();
                    });

                    $("#button-ok").click(function (e) {
                        createUser();
                    });

                    users.getAll(function (usersMessage) {
                        displayUsers(usersMessage);
                    });

                });

                function get(input) {
                    var jInput = $("#" + input);
                    return {
                        val: jInput.val(),
                        set: function(v) {
                            jInput.val(v);
                        },
                        reset: function () {
                            var group = jInput.closest(".control-group");
                            group.removeClass("error");
                            group.find(".help-inline").text("");
                        },
                        invalid: function (message) {
                            var group = jInput.closest(".control-group");
                            group.addClass("error");
                            group.find(".help-inline").text(message);
                        }
                    };
                }

                function getInput() {

                    function required(v) {
                        if (!v.val) {
                            v.invalid("required");
                            return false;
                        }
                        return true;
                    }

                    function match(v1, v2) {
                        if (v1.val != v2.val) {
                            v1.invalid("does not match");
                            return false;
                        }
                        return true;
                    }

                    return {
                        loginName: get("input-login-name"),
                        fullName: get("input-full-name"),
                        password: get("input-password"),
                        confirmPassword: get("input-password-confirm"),

                        validate: function () {
                            this.loginName.reset();
                            this.fullName.reset();
                            this.password.reset();
                            this.confirmPassword.reset();

                            if (!required(this.loginName))
                                return false;
                            if (!required(this.fullName))
                                return false;
                            if (!required(this.password))
                                return false;
                            if (!required(this.confirmPassword))
                                return false;
                            if (!match(this.password, this.confirmPassword))
                                return false;
                            return true;
                        }
                    };
                }

                function createUser() {
                    var inputData = getInput();
                    if (inputData.validate()) {
                        var data = {
                            loginName: inputData.loginName.val,
                            fullName: inputData.fullName.val,
                            password: inputData.password.val,
                        };
                        users.create(data, function () {
                            alert("OK");
                        });
                    }
                }

                function displayUsers(users) {
                    $("#user-list-container").html($.render.usersTemplate(users));
                    $(".user-login").click(function (e) {
                        var login = $(this).attr('data-login');
                        e.preventDefault();
                        displayUserDetails(login);
                    });
                }

                function displayUserDetails(login) {
                    $("#user-details-dialog").dialog({
                        modal: true,
                        width: 600,
                        height: 300,
                        title: "User Details",
                        autoResize: true,
                        open: function (event, ui) {
                            users.get(login, function (userData) {
                                $("#user-details-dialog-content").html($.render.userTemplate(userData.data));
                                $("#button-details-edit").click(function (e) {
                                    e.preventDefault();
                                    displayEditUser(userData);
                                });
                            });

                        }
                    });
                }

                function displayCreateUser() {
                    $("#edit-user-details-dialog").dialog({
                        modal: true,
                        width: 600,
                        height: 400,
                        title: "New User",
                        autoResize: true,
                        open: function (event, ui) {
                            var inputs = getInput();
                            $(".create-only").show();
                            $("#button-ok").text("Create");
                        }
                    });
                }

                function displayEditUser(userData) {
                    $("#edit-user-details-dialog").dialog({
                        modal: true,
                        width: 600,
                        height: 220,
                        title: "Edit User",
                        autoResize: true,
                        open: function (event, ui) {
                            var inputs = getInput();
                            inputs.loginName.set(userData.data.loginName);
                            inputs.fullName.set(userData.data.fullName);
                            $(".create-only").hide();
                            $("#button-ok").text("Update");
                        }
                    });
                }

            });
    </script>
</body>
</html>
