<!doctype html>
<html>
<head>
    <title>Edit Projection Source</title>
    <script src="/web/es/lib/jquery/jquery-1.8.0.min.js" type="text/javascript"></script>
    <script src="/web/es/lib/jsrender/jsrender.js" type="text/javascript"></script>
    <script src="/web/es/lib/require.js" type="text/javascript"></script>
    <script src="/web/es/js/es.tmpl.js" type="text/javascript"></script>
    <script id="r-head">
        es.tmpl.renderHead();
    </script>
    <style>
        .container
        {
            width: inherit;
            margin-left: 50px;
            margin-right: 50px;
        }
    </style>
</head>
<body>
    <div id="content">
        <h1>One Time Projection</h1>
        <h2 id="status"></h2>
        <div class="row">
            <div class="span12">
                <div id="commands-container">
                    <ul style="display: inline;">
                        <li><a href="#" id="btn-start" class="btn btn-success">Run</a></li>
                        <li><a href="#" id="btn-stop" class="btn btn-danger">Break</a></li>
                    </ul>
                </div>
            </div>
        </div>
        <div>
            <div class="control-group">
                <label class="control-label" for="source">
                    <strong>Source</strong></label>
                <div class="controls">
                    <textarea id="source" class="json" spellcheck="false" wrap="off" style="display: block; width: 100%;"></textarea>
                </div>
            </div>
            <div class="control-group">
                <label class="control-label" for="source">
                    <strong>State</strong></label>
                <div class="controls">
                    <textarea id="state" spellcheck="false" wrap="off" cols="100" rows="20"></textarea>
                </div>
            </div>
            <div class="control-group">
                <label class="control-label" for="emit"><strong>Emit Enabled</strong></label>
                <div class="controls">
                    <input type="checkbox" id="emit" /></div>
            </div>
            <div class="control-group">
                <div class="controls" id="update-source-container">
                    <button id="update-button" class="btn btn-success">
                        Update</button>
                </div>
            </div>
        </div>

        <script id="r-body">
            es.tmpl.renderBody();
        </script>
    </div>

    <script type="text/javascript">
        require.config({
            baseUrl: "/web/es/js",
            paths: {
            },
        });

        require(['projections/Controller', 'projections/ui/Editor'], function (controller, editor) {

            var lastSource = "";

            function statusChanged(status) {
                $("#status").html(status.status + ($.isNumeric(status.progress) && status.progress != -1 ? ("(" + status.progress.toFixed(1) + "%)") : ""));
            }

            function stateChanged(state) {
                $("#state").text(state);
            }

            function sourceChanged(source) {
                var current = $("#source").text();
                if (current !== source.query) {
                    if (lastSource === current) {
                        $("#source").text(source.query);
                    } else {
                        console.log("Ignoring query source changed outside. There are local pending changes.");
                    }
                }
                $("#emit").attr("checked", source.emitEnabled);
            }

            $(function () {
                var projectionStatusUrl = location.hash.substr(1);
                var projectionMonitor = controller.create(projectionStatusUrl);
                projectionMonitor.subscribe({ statusChanged: statusChanged, stateChanged: stateChanged, sourceChanged: sourceChanged });

                var projectionEditor = editor.create(projectionStatusUrl, projectionMonitor);
            });
        });

    </script>
</body>
</html>
